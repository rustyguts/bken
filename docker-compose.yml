services:
  # ── dev services (default, no profile) ──────────────────────────────────────
  server:
    build:
      context: ./server
      target: dev
    volumes:
      - ./server:/app
    network_mode: host

  client:
    build:
      context: ./client
      target: dev
      args:
        UID: ${UID}
        GID: ${GID}
    user: "${UID}:${GID}"
    network_mode: host
    environment:
      - DISPLAY=${DISPLAY}
      - XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR}
      - XAUTHORITY=/tmp/.Xauthority
      - WEBKIT_DISABLE_COMPOSITING_MODE=1
      - WEBKIT_DISABLE_DMABUF_RENDERER=1
      - LIBGL_ALWAYS_SOFTWARE=1
      - BKEN_USERNAME=Brendan
      - BKEN_TEST_USER=1
      - GOPATH=/go
      - HOME=/tmp
    volumes:
      - ./client:/app
      - /app/frontend/dist                  # anonymous: owned by UID at build time
      - /app/frontend/node_modules          # anonymous: avoids cross-platform issues
      - /app/frontend/wailsjs/runtime       # anonymous: wails writes runtime files here
      - /app/build                          # anonymous: compiled binary output
      - /tmp/.X11-unix:/tmp/.X11-unix
      - ${XAUTHORITY}:/tmp/.Xauthority:ro
      - ${XDG_RUNTIME_DIR}/pipewire-0:${XDG_RUNTIME_DIR}/pipewire-0
    devices:
      - /dev/snd:/dev/snd
    security_opt:
      - seccomp:unconfined
    depends_on:
      - server